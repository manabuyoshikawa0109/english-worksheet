<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>英語ワークシート</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* =============================================
    フォント設定
    ============================================= */
    @font-face {
      font-family: "CJ Gothic";
      src: url("fonts/CJ_Gothic/CJ_Gothic_2019-Regular.woff2") format("woff2"),
        url("fonts/CJ_Gothic/CJ_Gothic_2019-Regular.woff") format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      /*
      フォントファイルの内部メトリクス(文字の高さや行間を決める設計上の数値情報。OS・ブラウザ間で解釈が異なる)を
      強制的に上書きし、異なる環境で同一の縦配置に揃える。
      以下合計で「行間」を計算し、line-heightの挙動を決める。
      */
      ascent-override: 90%; /* ベースライン(文字が乗る線)から上に伸びる高さ */
      descent-override: 10%; /* ベースラインから下に伸びる高さ */
      line-gap-override: 0%; /* ascentとdescentの外側に追加される推奨余白 */
    }

    @font-face {
      font-family: "Nunito";
      src: url("fonts/Nunito/Nunito-VariableFont_wght.ttf") format("truetype");
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Nunito";
      src: url("fonts/Nunito/Nunito-Italic-VariableFont_wght.ttf") format("truetype");
      font-weight: 100 900;
      font-style: italic;
      font-display: swap;
    }
    /* =============================================
    パーツの共通CSS
    ============================================= */
    /* input-group内のフォームは横一杯に幅を取らないようにする */
    .input-group > .form-select {
      flex: none;
      width: auto;
    }

    .input-group > input[type="color"] {
      flex: none;
      width: 50px;
    }

    /* ボタンに影をつけて立体感を出す */
    button {
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.35);
      text-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
    }

    /* ボタンをクリックした時に沈み込むようにし、躍動感を出す */
    button:active {
      transform: translateY(1px);
    }

    body {
      font-family: sans-serif;
      background: #f5f5f5; /* ワークシートを囲う要素の背景色を変更 */
      display: flex; /* サイドバーとワークシートを横並びにする */
      height: 100vh;
    }

    .sidebar {
      width: 300px;
      background: #343a40;
      color: #fff;
      padding: 20px;
      overflow-y: scroll;
    }

    .sidebar h4 {
      font-size: 1rem;
    }

    .main-content {
      /* フレックスコンテナ内に余白があるとき、フレックスアイテムに指定した比率の分だけ余白を追加
      ここでは片方のフレックスアイテムに「1」を指定しているのでこのフレックスアイテムが画面右側まで伸び余白を埋める
      bodyタグがフレックスコンテナとなる */
      flex-grow: 1;
      overflow-y: scroll;
      padding: 30px;
    }

    /* =============================================
    ワークシートのCSS
    ============================================= */
    .worksheet {
      max-width: 900px;
      margin: 0 auto; /* 左右中央揃え */
      background: #fff;
      padding: 30px 40px;
      border: 1px solid #ccc;
    }

    .worksheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 1rem;
    }

    .student-info {
      display: grid; /* フレックスアイテムをx、y軸方向に配置 */
      grid-template-columns: repeat(3, 80px); /* 横並びにするフレックスアイテム数とフレックスアイテムの横幅 */
      border: 1px solid #000;
    }

    .student-info-box {
      border-left: 1px solid #000;
      padding: 4px 6px;
      height: 80px;
      display: flex;
      flex-direction: column; /* フレックスアイテムを上から下に配置 */
      justify-content: space-between;
    }

    .student-info-box:first-child {
      border-left: none;
    }

    .student-info-label {
      font-size: 0.65rem;
      font-weight: bold;
    }

    .student-info-input {
      font-size: 1.5rem;
      border: none;
      background: transparent;
      width: 100%;
      padding: 0;
    }

    .student-info-input:focus {
      outline: none; /* フォームにカーソルが当たった際、輪郭線を表示しない */
    }

    .student-name-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      font-weight: bold;
      position: absolute;
      top: -1.3rem;
      left: 0;
      right: 0;
    }

    .date {
      letter-spacing: 35px; /* テキストの水平方向の字間のスペース */
    }

    .line-group {
      position: relative;
      height: 51px;
      margin-bottom: 50px;
      /* フレックスコンテナ内に余白があるとき、フレックスアイテムに指定した比率の分だけ余白を追加
      ここでは片方のフレックスアイテムに「1」を指定しているのでこのフレックスアイテムが画面右側まで伸び余白を埋める
      bodyタグがフレックスコンテナとなる */
      flex-grow: 1;
    }

    .student-name {
      margin-top: 20px;
      margin-bottom: 0 !important;
    }

    .line {
      position: absolute;
      left: 0;
      right: 0;
      height: 1px;
    }

    .line1 {
      top: 0;
    }

    .line2 {
      top: 16px;
    }

    .line3 {
      top: 36px;
    }

    .line4 {
      top: 50px;
    }

    /* 入力フォーム（scaleXで拡大縮小） */
    .line-input {
      font-size: 50px;
      line-height: 32px;
      padding: 0 10px;
      font-family: "CJ Gothic", sans-serif;
      white-space: nowrap; /* 改行しない */
      cursor: pointer;
      min-width: 100%; /* 最低横幅は100% */
      width: fit-content; /* 横幅は入力文字の長さに合わせる */
      height: 100%;
      transform-origin: left center; /* 要素を回転や拡大・縮小する際の基点(原点) */
      transform: scaleX(1); /* 要素のX軸方向への拡大率 */
    }

    .line-input:focus {
      outline: 2px solid rgba(0, 123, 255, 0.3);
      background-color: rgba(0, 123, 255, 0.08);
    }

    .worksheet-title {
      margin-bottom: 1.4rem;
      text-align: center;
      font-weight: bold;
      font-size: 2rem;
      height: 48px;
      border-bottom: 2px solid #000000;
      white-space: nowrap; /* 自動改行しない */
      overflow: hidden; /* 入力文字が横幅を超えた場合、超えた文字は表示しない */
      text-overflow: ellipsis; /* 入力文字が横幅を超えた場合、3点表示する */
      font-family: "Nunito", sans-serif;
    }

    /* =============================================
    タブレット対応
    ============================================= */
    @media (max-width: 768px) {
      .sidebar {
        min-width: 300px;
      }

      .worksheet {
        width: 900px;
      }
    }

    /* =============================================
    印刷対応
    ============================================= */
    @media print {
      :-webkit-scrollbar {
        display: none; /* Windowsでスクロールバーが表示されるのを防ぐ */
      }

      @page {
        size: A4 landscape; /* A4用紙横向き */
        margin: 0; /* 用紙の余白 */
      }
    }
  </style>
</head>

<body>
  <div class="sidebar">

    <h4>ワークシートのタイトル</h4>
    <input id="worksheetTitleInput" type="text" class="form-control" placeholder="例）Today's weather" />

    <hr>

    <h4 class="mt-4">文字のスタイル</h4>
    <div class="d-flex align-items-center gap-2">
      <div class="input-group w-auto">
        <input type="color" id="textColor" class="form-control form-control-color" />
        <span class="input-group-text">色</span>
      </div>
      <div class="btn-group" role="group" aria-label="文字のスタイル">
        <button id="btnBold" class="btn btn-primary fw-bold" title="太字">
          B
        </button>
        <button id="btnItalic" class="btn btn-primary fst-italic" title="イタリック">
          I
        </button>
        <button id="btnUnderline" class="btn btn-primary text-decoration-underline" title="下線">
          U
        </button>
    </div>
    </div>

    <hr>

    <h4 class="mt-4">罫線のスタイル</h4>
    <div class="input-group mb-4">
      <span class="input-group-text">第</span>
      <select id="targetLine" class="form-select">
        <option value="line1">1</option>
        <option value="line2">2</option>
        <option value="line3">3</option>
        <option value="line4">4</option>
      </select>
      <span class="input-group-text">罫線</span>
    </div>
    <div class="input-group">
      <select id="lineStyle" class="form-select">
        <option value="solid">直</option>
        <option value="dotted">点</option>
        <option value="dashed">ダッシュ</option>
      </select>
      <span class="input-group-text">線</span>
      <input id="lineColor" type="color" class="form-control form-control-color" />
      <span class="input-group-text">色</span>
    </div>

    <hr>

    <h4 class="mt-4">行の幅</h4>
    <div class="input-group mb-4">
      <select id="targetRow" class="form-select"></select>
      <span class="input-group-text">行目</span>
      <input id="rowScaleValue" type="number" class="form-control" value="100" min="0" max="100" step="1" >
      <span class="input-group-text">%</span>
    </div>
    <input id="rowScaleRange" type="range" class="w-100" value="100" min="0" max="100" step="1">

    <hr>

    <h4 class="mt-4">その他の操作</h4>
    <div class="d-flex align-items-center gap-2">
      <button id="downloadPdfBtn" class="btn btn-primary w-50">
        <i class="fa-regular fa-file-pdf"></i>
        PDF出力
      </button>
      <button id="clearBtn" class="btn btn-danger w-50">
        <i class="fa-solid fa-trash-can"></i>
        クリア
      </button>
    </div>
  </div>

  <!-- ワークシート -->
  <div class="main-content">
    <div id="worksheet" class="worksheet">
      <div class="worksheet-header">
        <div class="student-info">
          <div class="student-info-box">
            <div class="student-info-label">Grade</div>
            <!-- input要素だとhtml2canvasでキャプチャした際に入力文字が上に配置され、切れてしまう不具合があるためcontenteditableを使用 -->
            <!-- 参考：https://github.com/niklasvh/html2canvas/issues/2008 -->
            <div class="student-info-input" contenteditable="true"></div>
          </div>
          <div class="student-info-box">
            <div class="student-info-label">Class</div>
            <div class="student-info-input" contenteditable="true"></div>
          </div>
          <div class="student-info-box">
            <div class="student-info-label">No.</div>
            <div class="student-info-input" contenteditable="true"></div>
          </div>
        </div>

        <div class="line-group student-name">
          <div class="line line1"></div>
          <div class="line line2"></div>
          <div class="line line3"></div>
          <div class="line line4"></div>
          <div class="student-name-label">
            <span>Name</span><span>Date<span class="date"> ・・</span></span>
          </div>
          <div class="line-input" contenteditable="true"></div>
        </div>
      </div>

      <div id="worksheetTitle" class="worksheet-title"></div>
      <div id="lines"></div>
    </div>
  </div>

  <!-- スクリプト -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js" integrity="sha512-+EeCylkt9WHJk5tGJxYdecHOcXFRME7qnbsfeMsdQL6NUPYm2+uGFmyleEqsmVoap/f3dN/sc3BX9t9kHXkHHg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // ワークシートの行を生成
    for (let i = 1; i <= 9; i++) {
      $("#lines").append(`
        <div class="line-group">
          <div class="line line1"></div>
          <div class="line line2"></div>
          <div class="line line3"></div>
          <div class="line line4"></div>
          <div class="line-input" contenteditable="true"></div>
        </div>
      `);
    }

    // 入力された文字をワークシートのタイトルに出力
    $("#worksheetTitleInput").on("input", function() {
      $("#worksheetTitle").text($(this).val());
    });

    // 直近にフォーカスした行の入力フォームを保持
    let $lastActiveLineInput = null;
    $(document).on("focus click keyup", ".line-input", function () {
      $lastActiveLineInput = this;
    });

    // 選択した文字の色を変更
    $("#textColor").on("input", function() {
      if (!$lastActiveLineInput) {
        alert("スタイルを変更したい文字を選択してください。");
        return;
      }
      $lastActiveLineInput.focus();
      // 書式変更をHTMLタグではなくCSSスタイルで適用するよう、execCommand()の動作モードを切り替える
      document.execCommand("styleWithCSS", false, true);
      document.execCommand("foreColor", false, $(this).val());
    });

    // 文字のフォントを変更する(太字・斜体・下線)
    function changeTargetFontStyle(cmd) {
      if (!$lastActiveLineInput) {
        alert("スタイルを変更したい文字を選択してください。");
        return;
      }
      $lastActiveLineInput.focus();
      document.execCommand("styleWithCSS", false, true);
      document.execCommand(cmd, false, null);
    }

    $("#btnBold").on("mousedown", function(e) {
      e.preventDefault();
      changeTargetFontStyle("bold");
    });

    $("#btnItalic").on("mousedown", function(e) {
      e.preventDefault();
      changeTargetFontStyle("italic");
    });

    $("#btnUnderline").on("mousedown", function(e) {
      e.preventDefault();
      changeTargetFontStyle("underline");
    });

    // 各罫線のスタイルを保持した変数
    const lineStyles = {
      line1: { color: "#000000", style: "solid" },
      line2: { color: "#000000", style: "dashed" },
      line3: { color: "#33CCFF", style: "solid" },
      line4: { color: "#000000", style: "solid" },
    };

    // 対象罫線のスタイルを変更する
    function changeTargetLineStyle(targetLine) {
      const lineStyle = lineStyles[targetLine];
      $(`.${targetLine}`).css("border-top", `1px ${lineStyle.style} ${lineStyle.color}`);
    }

    // 対象罫線のスタイルをフォームに保持する
    function setTargetLineStyleToForm(targetLine) {
      const lineStyle = lineStyles[targetLine];
      $("#lineStyle").val(lineStyle.style);
      $("#lineColor").val(lineStyle.color);
    }

    // 罫線のスタイル初期化
    for (let i = 1; i <= 4; i++) {
      changeTargetLineStyle(`line${i}`);
    }

    // サイドバーで対象の罫線が変更された場合、そのスタイルをフォームに保持する
    setTargetLineStyleToForm("line1");
    $("#targetLine").on("change", function() {
      setTargetLineStyleToForm($(this).val());
    });

    // サイドバーで罫線のスタイルが変更された場合、対象の罫線のスタイルを変更する
    $("#lineColor, #lineStyle").on("input change", function() {
      const targetLine = $("#targetLine").val();
      const color = $("#lineColor").val();
      const style = $("#lineStyle").val();

      // 対象罫線のセレクトボックスが変更された際、その罫線のスタイルと色を入力フォームに保持するためlineStyles変数の値を変えておく
      lineStyles[targetLine].color = color;
      lineStyles[targetLine].style = style;
      changeTargetLineStyle(targetLine);
    });

    const STEP = 1, // 拡大・縮小のステップ数
          MIN = 0, // 拡大・縮小の最小値
          MAX = 100; // 拡大・縮小の最大値

    // 行ごとの拡大・縮小率
    const scales = {
      0: 100,
      1: 100,
      2: 100,
      3: 100,
      4: 100,
      5: 100,
      6: 100,
      7: 100,
      8: 100,
      9: 100,
    };

    //「行の幅」のセレクトボックス
    const $rowSelect = $("#targetRow");

    // 行の入力フォームの数だけセレクトボックスのオプション要素を追加
    $(".line-input").each((i) =>
      $rowSelect.append(`<option value="${i}">${i + 1}</option>`)
    );

    //「行の幅」のセレクトボックスから対象行の入力フォームを取得
    function $targetLineInput() {
      const value = Number($rowSelect.val());
      return $(".line-input").eq(value);
    }

    // 行の拡大・縮小率を「行の幅」の数値、範囲選択フォームにセット
    function setTargetRowScaleToForm(scale) {
      $('#rowScaleRange, #rowScaleValue').val(scale);
    }

    // 対象行の入力フォームに拡大・縮小率を適用
    function applyScaleToTargetLineInput(scale) {
      $targetLineInput().css("transform", `scaleX(${scale / 100})`);
    }

    //「行の幅」の数値、範囲選択フォーム変更時のイベント
    $('#rowScaleRange, #rowScaleValue').on('input', function() {
      const value = Number($(this).val());
      if (!(MIN <= value && value <= MAX)) {
        alert(`行の幅の倍率は${MIN} 〜 ${MAX}の間で指定してください。`);
        return;
      }

      //「行の幅」のセレクトボックスが変更された時、選択された行の拡大・縮小率をフォームに保持するために変数の値を変えておく
      const targetRowSelectValue = Number($rowSelect.val());
      scales[targetRowSelectValue] = value;
      applyScaleToTargetLineInput(value);
      setTargetRowScaleToForm(value);
    });

    //「行の幅」のセレクトボックスが変更した時のイベント
    $("#targetRow").on("change", function() {
      const value = Number($(this).val());
      const scale = scales[value];
      setTargetRowScaleToForm(scale);
      $targetLineInput().focus();
    });

    // ワークシート上の全文字をクリア
    $("#clearBtn").on("click", function () {
      if (!confirm("ワークシート上の文字をすべて削除します。よろしいですか？")) return;
      $("#worksheetTitle").text("");
      $("#worksheetTitleInput, .student-info-input").val("");
      $(".line-input").html('');
      $(".line-input").first().focus();
    });

    // ワークシートをPDF出力
    $("#downloadPdfBtn").on("click", function () {
      // jsPDFをCDNから読み込むとwindowグローバルオブジェクトにjspdfオブジェクトが追加される
      // 分割代入でwindow.jspdfオブジェクトの中のjsPDFプロパティを変数に格納する
      const { jsPDF } = window.jspdf;
      // $("#worksheet")はjQueryオブジェクトを変えるので、$("#worksheet").get(0)でDOM要素(html)を取得
      const $worksheetElement = $("#worksheet").get(0);
      // DOM要素をcanvas要素に変換
      html2canvas($worksheetElement).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF();
        // PDFの高さと横幅を取得
        const width = pdf.internal.pageSize.getWidth();
        const height = pdf.internal.pageSize.getHeight();
        // 引数：画像データ、画像形式、左上頂点のx軸、左上頂点のy軸、追加する画像の幅、追加する画像の高さ
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save("英語ワークシート.pdf");
      })
    });
  </script>
</body>

</html>