<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>英語ワークシート</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* --- 既存フォントなどはそのまま --- */
      @font-face {
        font-family: "CJ Gothic";
        src: url("fonts/CJ_Gothic/CJ_Gothic_2019-Regular.woff2") format("woff2"),
          url("fonts/CJ_Gothic/CJ_Gothic_2019-Regular.woff") format("woff");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Nunito";
        src: url("fonts/Nunito/Nunito-VariableFont_wght.ttf") format("truetype");
        font-weight: 100 900;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Nunito";
        src: url("fonts/Nunito/Nunito-Italic-VariableFont_wght.ttf")
          format("truetype");
        font-weight: 100 900;
        font-style: italic;
        font-display: swap;
      }

      body {
        margin: 0;
        font-family: sans-serif;
        background: #f5f5f5;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .sidebar {
        width: 300px;
        background: #343a40;
        color: #fff;
        padding: 20px;
        flex-shrink: 0;
        overflow-y: auto;
      }
      .sidebar h4 {
        font-size: 1rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .color-picker {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .color-picker label {
        font-size: 0.85rem;
        width: 56px;
        margin: 0;
      }
      .color-picker input[type="color"] {
        width: 42px;
        height: 32px;
        padding: 0;
        border: none;
        cursor: pointer;
      }
      .color-picker select {
        font-size: 0.9rem;
        padding: 4px 6px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        background: #fff;
        color: #000;
      }

      .main-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 30px;
      }
      .worksheet {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        padding: 30px 40px;
        border: 1px solid #ccc;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        font-family: "Nunito", "Noto Sans JP", sans-serif;
      }

      .header-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        margin-bottom: 1rem;
      }
      .grade-block {
        display: grid;
        grid-template-columns: repeat(3, 80px);
        border: 1px solid #000;
        flex-shrink: 0;
      }
      .header-cell {
        border-left: 1px solid #000;
        padding: 4px 6px;
        height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .header-cell:first-child {
        border-left: none;
      }
      .header-label {
        font-size: 0.65rem;
        font-weight: bold;
      }
      .header-input {
        font-size: 1.5rem;
        border: none;
        background: transparent;
        width: 100%;
        padding: 0;
      }
      .header-input:focus {
        outline: none;
      }

      .name-date-block {
        position: relative;
        height: 56px;
        flex-grow: 1;
        min-width: 0;
        margin-top: 15px;
      }
      .name-date-block .line {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
      }
      .line1 {
        top: 0;
        background-color: #007bff;
      }
      .line2 {
        top: 18px;
        border-top: 1px dashed #66b3ff;
      }
      .line3 {
        top: 36px;
        border-top: 1px dashed #66b3ff;
      }
      .line4 {
        top: 54px;
        background-color: #007bff;
      }

      .name-date-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        font-weight: bold;
        position: absolute;
        top: -1.2rem;
        left: 0;
        right: 0;
      }
      .date-dots {
        font-weight: normal;
        font-size: 0.8em;
        letter-spacing: 20px;
        margin-left: 5px;
      }
      .name-date-inputs {
        display: flex;
        justify-content: space-between;
        position: absolute;
        inset: 0;
        padding: 0 10px;
        gap: 10px;
      }
      .four-line-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 3rem;
        line-height: 56px;
        padding: 0 10px 9px 10px;
        font-family: "CJ Gothic", sans-serif;
        white-space: pre-wrap;
        overflow: hidden;
        color: #000;
      }
      .four-line-input:focus {
        outline: 2px solid rgba(0, 123, 255, 0.3);
        background-color: rgba(0, 123, 255, 0.08);
      }

      .worksheet-title {
        margin: 0 0 1.4rem;
        text-align: center;
        font-weight: bold;
        font-size: 2rem;
        line-height: 48px;
        height: 48px;
        border-bottom: 2px solid #0b76b7;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: "Nunito", sans-serif;
      }

      .line-group {
        position: relative;
        height: 56px;
        margin-bottom: 50px;
      }
      .line-group .line {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
      }

      /* 入力フォーム（scaleXで拡大縮小） */
      .line-input {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        background: transparent;
        font-size: 3rem;
        line-height: 56px;
        padding: 0 10px 9px 10px;
        font-family: "CJ Gothic", sans-serif;
        white-space: nowrap;
        overflow: hidden;
        cursor: text;
        color: #000;
        min-width: 100%;
        width: fit-content;
        right: auto;
        transform-origin: left center;
        transform: scaleX(1);
      }
      .line-input:focus {
        outline: 2px solid rgba(0, 123, 255, 0.3);
        background-color: rgba(0, 123, 255, 0.08);
      }

      /* ── 拡大・縮小UI ── */
      .zoom-inline {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .zoom-inline .form-select {
        width: auto;
      }
      .zoom-panel {
        display: flex;
        align-items: center;
      }
      .zw-btn {
        position: relative;
        height: 40px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        color: #fff;
        font-weight: 800;
        letter-spacing: 0.5px;
        background: linear-gradient(
          180deg,
          #7db2ff 0%,
          #5b8eea 45%,
          #3a6fd6 100%
        );
        box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
      }
      .zw-btn:active {
        transform: translateY(1px);
      }
      .zw-btn .arrow {
        font-size: 1rem;
        opacity: 0.9;
      }
      .zw-btn .A {
        font-size: 1.1rem;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
      }
      .zw-left {
        margin-right: -5px;
      }
      .zw-right {
        margin-left: -5px;
      }
      .zw-left .A {
        transform: scaleX(1.2);
      }
      .zw-right .A {
        transform: scaleX(0.5);
      }
      .zw-percent {
        height: 34px;
        padding: 0 5px;
        border-radius: 8px;
        background: #cfefff;
        color: #0b4a8f;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8),
          0 1px 0 rgba(0, 0, 0, 0.2);
        cursor: pointer;
        user-select: none;
        z-index: 1;
      }
      .zw-percent small {
        font-weight: 700;
        font-size: 0.95rem;
      }

      /* 文字装飾ツールの見た目（任意） */
      .format-toolbar .btn {
        width: 40px;
      }

      @media (max-width: 768px) {
        .header-wrapper {
          flex-direction: column;
        }
      }
      @media print {
        body {
          background: #fff;
        }
        .sidebar {
          display: none !important;
        }
        .main-content {
          padding: 0 !important;
        }
        .worksheet {
          display: block !important;
          margin: 0 !important;
          border: none !important;
          box-shadow: none !important;
          max-width: 100% !important;
          width: 100% !important;
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <!-- ✅ サイドバー -->
    <div class="sidebar">
      <h4>タイトル</h4>
      <input
        type="text"
        id="titleInput"
        class="form-control mb-3"
        placeholder="例）Today's weather"
      />

      <h4>文字のスタイル</h4>
      <div class="d-flex align-items-center gap-2">
        <input
          type="color"
          id="textColorPicker"
          value="#000000"
          style="
            width: 42px;
            height: 32px;
            cursor: pointer;
            padding: 0;
            border: none;
          "
          title="文字色を選択"
        />
        <div
          class="btn-group format-toolbar"
          role="group"
          aria-label="文字装飾（line-input）"
        >
          <button
            id="btnBold"
            class="btn btn-outline-light fw-bold"
            title="太字 (Ctrl+B / ⌘B)"
          >
            B
          </button>
          <button
            id="btnItalic"
            class="btn btn-outline-light fst-italic"
            title="斜体 (Ctrl+I / ⌘I)"
          >
            I
          </button>
          <button
            id="btnUnderline"
            class="btn btn-outline-light text-decoration-underline"
            title="下線 (Ctrl+U / ⌘U)"
          >
            U
          </button>
        </div>
      </div>

      <!-- ▼ 罫線のスタイル（対象を選んで編集） -->
      <h4>罫線のスタイル</h4>
      <div class="mb-2 d-flex align-items-center gap-2">
        <select
          id="lineTarget"
          class="form-select form-select-sm"
        >
          <option value="line1">第1罫線</option>
          <option value="line2">第2罫線</option>
          <option value="line3">第3罫線</option>
          <option value="line4">第4罫線</option>
        </select>
        <div class="color-picker">
          <input type="color" id="lineColor" />
          <select id="lineStyle" class="form-select form-select-sm">
            <option value="solid">直線</option>
            <option value="dotted">点線</option>
            <option value="dashed">ダッシュ線</option>
          </select>
        </div>
      </div>

      <!-- ── 拡大・縮小 ── -->
      <h4 class="mt-4">行の拡大・縮小</h4>
      <div class="zoom-inline">
        <select id="lineSelector" class="form-select form-select-sm"></select>
        <div class="zoom-panel">
          <button id="btnZoomIn" class="zw-btn zw-left" title="拡大（左のA）">
            <span class="arrow">←</span><span class="A">A</span
            ><span class="arrow">→</span>
          </button>
          <div
            id="zoomPercent"
            class="zw-percent"
            title="ダブルクリックで100%に戻す"
          >
            <small id="zoomVal">100%</small>
          </div>
          <button id="btnZoomOut" class="zw-btn zw-right" title="縮小（右のA）">
            <span class="arrow">→</span><span class="A">A</span
            ><span class="arrow">←</span>
          </button>
        </div>
      </div>

      <h4 class="mt-4">その他の操作</h4>
      <button id="btnPrint" class="btn btn-primary w-100 mb-2">
        <i class="fa-solid fa-print"></i>
        印刷プレビューを開く
      </button>
      <button id="btnClearAll" class="btn btn-danger w-100 mb-3">
        <i class="fa-solid fa-trash"></i>
        ワークシート上の文字を削除
      </button>
    </div>

    <!-- ✅ ワークシート -->
    <div class="main-content">
      <div class="worksheet">
        <div class="header-wrapper">
          <div class="grade-block">
            <div class="header-cell">
              <div class="header-label">Grade</div>
              <input type="text" class="header-input" />
            </div>
            <div class="header-cell">
              <div class="header-label">Class</div>
              <input type="text" class="header-input" />
            </div>
            <div class="header-cell">
              <div class="header-label">No.</div>
              <input type="text" class="header-input" />
            </div>
          </div>

          <div class="name-date-block">
            <div class="line line1"></div>
            <div class="line line2"></div>
            <div class="line line3"></div>
            <div class="line line4"></div>
            <div class="name-date-labels">
              <span>Name</span
              ><span>Date<span class="date-dots"> ・ ・ </span></span>
            </div>
            <div class="name-date-inputs">
              <div class="four-line-input" contenteditable="true"></div>
            </div>
          </div>
        </div>

        <div id="titleDisplay" class="worksheet-title"></div>
        <div class="lines-container" id="lines"></div>
      </div>
    </div>

    <!-- ✅ スクリプト -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      // 罫線スタイルの状態保持
      const lineStyles = {
        line1: { color: "#007bff", style: "solid" },
        line2: { color: "#66b3ff", style: "dotted" },
        line3: { color: "#66b3ff", style: "dotted" },
        line4: { color: "#007bff", style: "solid" },
      };
      function paintLine(lineKey) {
        const cfg = lineStyles[lineKey];
        document.querySelectorAll("." + lineKey).forEach((el) => {
          el.style.backgroundColor = "transparent";
          el.style.borderTop = `1px ${cfg.style} ${cfg.color}`;
        });
      }
      function syncControlsTo(lineKey) {
        const cfg = lineStyles[lineKey];
        document.getElementById("lineColor").value = cfg.color;
        document.getElementById("lineStyle").value = cfg.style;
      }
      function applyFromControls() {
        const lineKey = document.getElementById("lineTarget").value;
        lineStyles[lineKey].color = document.getElementById("lineColor").value;
        lineStyles[lineKey].style = document.getElementById("lineStyle").value;
        paintLine(lineKey);
      }

      // ── 直近にフォーカスした line-input を保持 ──
      let lastActiveEditable = null;
      $(document).on("focus click keyup", ".line-input", function () {
        lastActiveEditable = this;
      });

      // 文字色（line-input の選択範囲に適用）
      const textColorPicker = document.getElementById("textColorPicker");
      textColorPicker.addEventListener("input", () => {
        if (!lastActiveEditable) {
          alert("4本罫線の入力欄を選択してから操作してください。");
          return;
        }
        lastActiveEditable.focus();
        document.execCommand("styleWithCSS", false, true);
        document.execCommand("foreColor", false, textColorPicker.value);
      });

      // ── 文字装飾（太字／斜体／下線） ──
      function runFormat(cmd) {
        if (!lastActiveEditable) {
          alert("4本罫線の入力欄を選択してから操作してください。");
          return;
        }
        lastActiveEditable.focus();
        document.execCommand("styleWithCSS", false, true);
        document.execCommand(cmd, false, null);
      }
      // mousedownで実行して選択消失を防ぐ
      document.getElementById("btnBold").addEventListener("mousedown", (e) => {
        e.preventDefault();
        runFormat("bold");
      });
      document
        .getElementById("btnItalic")
        .addEventListener("mousedown", (e) => {
          e.preventDefault();
          runFormat("italic");
        });
      document
        .getElementById("btnUnderline")
        .addEventListener("mousedown", (e) => {
          e.preventDefault();
          runFormat("underline");
        });

      $(function () {
        // 本文生成
        const numLines = 9;
        for (let i = 0; i < numLines; i++) {
          $("#lines").append(`
        <div class="line-group">
          <div class="line line1"></div>
          <div class="line line2"></div>
          <div class="line line3"></div>
          <div class="line line4"></div>
          <div class="line-input" contenteditable="true" data-scale="100"></div>
        </div>
      `);
        }

        // タイトル
        $("#titleInput").on("input", function () {
          $("#titleDisplay").text(this.value);
        });

        // 罫線スタイル初期化
        ["line1", "line2", "line3", "line4"].forEach(paintLine);
        syncControlsTo("line1");
        $("#lineTarget").on("change", function () {
          syncControlsTo(this.value);
        });
        $("#lineColor, #lineStyle").on("input change", applyFromControls);

        // 拡大・縮小（1%刻み／0〜100%）
        const $selector = $("#lineSelector");
        $(".line-input").each((i) =>
          $selector.append(`<option value="${i}">${i + 1}行目</option>`)
        );
        const STEP = 1,
          MIN = 0,
          MAX = 100;
        function $current() {
          return $(".line-input").eq(parseInt($selector.val(), 10) || 0);
        }
        function setPercentDisplay(p) {
          $("#zoomVal").text(`${p}%`);
        }
        function applyScale($el, percent) {
          const p = Math.max(MIN, Math.min(MAX, percent | 0));
          $el.css("transform", `scaleX(${p / 100})`).attr("data-scale", p);
          setPercentDisplay(p);
        }
        setPercentDisplay(
          parseInt($(".line-input").first().attr("data-scale"), 10) || 100
        );
        $("#btnZoomIn").on("click", () => {
          const $t = $current();
          applyScale($t, +($t.attr("data-scale") || 100) + STEP);
        });
        $("#btnZoomOut").on("click", () => {
          const $t = $current();
          applyScale($t, +($t.attr("data-scale") || 100) - STEP);
        });
        $("#lineSelector").on("change", () => {
          const p = parseInt($current().attr("data-scale") || "100", 10);
          setPercentDisplay(p);
          $current().focus();
        });
        $("#zoomPercent").on("dblclick", () => applyScale($current(), 100));

        // 全消去（文字のみ）
        $("#btnClearAll").on("click", function () {
          if (
            !confirm(
              "ワークシート上の入力文字をすべて削除します。よろしいですか？"
            )
          )
            return;
          $("#titleInput").val("");
          $("#titleDisplay").text("");
          $(".worksheet .header-input").val("");
          $(".worksheet .four-line-input, .worksheet .line-input").each(
            function () {
              this.innerHTML = "";
            }
          );
          $(".line-input").first().focus();
        });

        // 印刷プレビュー
        $("#btnPrint").on("click", function () {
          if (
            document.activeElement &&
            (document.activeElement.isContentEditable ||
              document.activeElement.tagName === "INPUT")
          ) {
            document.activeElement.blur();
          }
          setTimeout(() => window.print(), 0);
        });
      });
    </script>
  </body>
</html>
